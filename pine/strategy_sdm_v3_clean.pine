//@version=6
strategy("VMSI-SDM v3 Clean Strategy", overlay=true, initial_capital=100000, default_qty_type=strategy.percent_of_equity, default_qty_value=100, commission_type=strategy.commission.percent, commission_value=0.1)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ðŸ“Œ v3 Clean Strategy - ìš”êµ¬ì‚¬í•­ ë°˜ì˜
// 
// ë³€ê²½ì‚¬í•­:
// 1. ì‹ í˜¸ ì¡°ê±´ ì™„í™” (trend_score >= 60)
// 2. ë§¤ë„ SL/TP ì œê±° (ë§¤ìˆ˜ë§Œ)
// 3. ë°°ê²½ìƒ‰ ì œê±°
// 4. ëª¨ë“  íƒ€ìž„í”„ë ˆìž„ ì§€ì›
// 5. ê°„ì†Œí™”ëœ UI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PARAMETERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

var g_basic = "ê¸°ë³¸ ì„¤ì •"
ema1_len = input.int(20, "EMA1 ê¸°ê°„", group=g_basic)
ema2_len = input.int(50, "EMA2 ê¸°ê°„", group=g_basic)
rsi_len = input.int(14, "RSI ê¸°ê°„", group=g_basic)
vcp_len = input.int(20, "VCP ê¸°ê°„", group=g_basic)

var g_signal = "ì‹ í˜¸ ì¡°ê±´"
trend_score_threshold = input.float(60, "íŠ¸ë Œë“œ ìŠ¤ì½”ì–´ ìž„ê³„ê°’ (50-80)", minval=50, maxval=80, step=5, group=g_signal)
rsi_buy_min = input.float(50, "RSI ìµœì†Œê°’ (ë§¤ìˆ˜)", minval=30, maxval=70, step=5, group=g_signal)
vol_mult_min = input.float(1.2, "ê±°ëž˜ëŸ‰ë°°ìˆ˜ ìµœì†Œê°’", minval=0.5, maxval=3, step=0.1, group=g_signal)

var g_weights = "ê°€ì¤‘ì¹˜"
alpha = input.float(0.8, "Alpha (EMA)", step=0.05, group=g_weights)
beta = input.float(0.35, "Beta (RSI)", step=0.05, group=g_weights)
gamma = input.float(0.7, "Gamma (Volume)", step=0.05, group=g_weights)
delta = input.float(0.6, "Delta (VCP)", step=0.05, group=g_weights)

var g_risk = "ë¦¬ìŠ¤í¬ ê´€ë¦¬ (ë§¤ìˆ˜ë§Œ)"
use_sl_tp = input.bool(true, "SL/TP ì‚¬ìš©", group=g_risk)
sl_pct = input.float(5.0, "ì†ì ˆ %", step=0.5, minval=1, maxval=20, group=g_risk)
tp_pct = input.float(10.0, "ìµì ˆ %", step=0.5, minval=2, maxval=50, group=g_risk)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

clamp(x, lo, hi) => math.max(lo, math.min(hi, x))
safe_div(a, b, fallback) => nz(b > 0 ? a / b : fallback, fallback)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INDICATORS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ema1 = ta.ema(close, ema1_len)
ema2 = ta.ema(close, ema2_len)
rsi = ta.rsi(close, rsi_len)
vol_avg = ta.sma(volume, 20)
vol_mult = safe_div(volume, vol_avg, 1.0)
vcp_high = ta.highest(high, vcp_len)
vcp_low = ta.lowest(low, vcp_len)
vcp_ratio = safe_div(vcp_high - vcp_low, vcp_high, 0.5)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TREND SCORE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

calc_trend_score() =>
    ema_above = ema1 > ema2 ? 1.0 : 0.0
    rsi_norm = rsi / 100.0
    vol_norm = math.min(vol_mult / 3.0, 1.0)
    vcp_norm = 1.0 - vcp_ratio
    raw = (alpha * ema_above + beta * rsi_norm + gamma * vol_norm + delta * vcp_norm) * 100.0
    clamp(raw, 0.0, 100.0)

trend_score = calc_trend_score()

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SIGNAL LOGIC (ì™„í™”ëœ ì¡°ê±´)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

buy_signal = barstate.isconfirmed and trend_score >= trend_score_threshold and rsi > rsi_buy_min and vol_mult > vol_mult_min and ema1 > ema2

sell_signal = barstate.isconfirmed and trend_score <= (100 - trend_score_threshold) and rsi < (100 - rsi_buy_min) and vol_mult > vol_mult_min and ema1 < ema2

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ORDERS (ë§¤ìˆ˜ë§Œ SL/TP)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// ë§¤ìˆ˜ ì§„ìž…
if buy_signal and strategy.position_size == 0
    qty = strategy.equity / close
    strategy.entry("Long", strategy.long, qty=qty)
    
    // ë§¤ìˆ˜ë§Œ SL/TP ì„¤ì •
    if use_sl_tp
        sl_price = close * (1 - sl_pct / 100)
        tp_price = close * (1 + tp_pct / 100)
        strategy.exit("Long Exit", "Long", stop=sl_price, limit=tp_price)

// ë§¤ë„ ì§„ìž… (SL/TP ì—†ìŒ - ì¸ë²„ìŠ¤ ì „ëžµì´ë¯€ë¡œ)
if sell_signal and strategy.position_size == 0
    qty = strategy.equity / close
    strategy.entry("Short", strategy.short, qty=qty)
    // SL/TP ì—†ìŒ!

// ì—­ì‹ í˜¸ ì²­ì‚°
if strategy.position_size > 0 and sell_signal
    strategy.close("Long", comment="Reverse")

if strategy.position_size < 0 and buy_signal
    strategy.close("Short", comment="Reverse")

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VISUALIZATION (ë°°ê²½ìƒ‰ ì œê±°)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

plot(ema1, "EMA1", color=color.new(color.blue, 0), linewidth=2)
plot(ema2, "EMA2", color=color.new(color.orange, 0), linewidth=2)

// SL/TP ë¼ì¸ (ë§¤ìˆ˜ë§Œ)
sl_line = strategy.position_size > 0 and use_sl_tp ? strategy.position_avg_price * (1 - sl_pct / 100) : na
tp_line = strategy.position_size > 0 and use_sl_tp ? strategy.position_avg_price * (1 + tp_pct / 100) : na

plot(sl_line, "ì†ì ˆê°€", color=color.new(color.red, 0), linewidth=2, style=plot.style_cross)
plot(tp_line, "ìµì ˆê°€", color=color.new(color.lime, 0), linewidth=2, style=plot.style_cross)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INFO PANEL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

var table panel = table.new(position.top_right, 2, 7, border_width=1)
if barstate.islast
    table.cell(panel, 0, 0, "Trend Score", bgcolor=color.new(color.gray, 20), text_color=color.white)
    table.cell(panel, 1, 0, str.tostring(trend_score, "#.0"), bgcolor=color.new(color.gray, 80), text_color=color.white)
    
    table.cell(panel, 0, 1, "RSI", bgcolor=color.new(color.gray, 20), text_color=color.white)
    table.cell(panel, 1, 1, str.tostring(rsi, "#.0"), bgcolor=color.new(color.gray, 80), text_color=color.white)
    
    pos_text = strategy.position_size > 0 ? "ë¡±" : strategy.position_size < 0 ? "ìˆ" : "ëŒ€ê¸°"
    pos_color = strategy.position_size > 0 ? color.new(color.green, 20) : strategy.position_size < 0 ? color.new(color.red, 20) : color.new(color.gray, 80)
    table.cell(panel, 0, 2, "í¬ì§€ì…˜", bgcolor=color.new(color.gray, 20), text_color=color.white)
    table.cell(panel, 1, 2, pos_text, bgcolor=pos_color, text_color=color.white)
    
    pnl_pct = strategy.position_size != 0 ? (close - strategy.position_avg_price) / strategy.position_avg_price * 100 : 0
    pnl_color = pnl_pct > 0 ? color.new(color.green, 20) : pnl_pct < 0 ? color.new(color.red, 20) : color.new(color.gray, 80)
    table.cell(panel, 0, 3, "í˜„ìž¬ì†ìµ", bgcolor=color.new(color.gray, 20), text_color=color.white)
    table.cell(panel, 1, 3, str.tostring(pnl_pct, "#.##") + "%", bgcolor=pnl_color, text_color=color.white)
    
    total_profit = strategy.netprofit / strategy.initial_capital * 100
    total_color = total_profit > 0 ? color.new(color.green, 20) : total_profit < 0 ? color.new(color.red, 20) : color.new(color.gray, 80)
    table.cell(panel, 0, 4, "ì´ìˆ˜ìµ", bgcolor=color.new(color.gray, 20), text_color=color.white)
    table.cell(panel, 1, 4, str.tostring(total_profit, "#.##") + "%", bgcolor=total_color, text_color=color.white)
    
    win_rate = strategy.wintrades > 0 ? strategy.wintrades / (strategy.wintrades + strategy.losstrades) * 100 : 0
    table.cell(panel, 0, 5, "ìŠ¹ë¥ ", bgcolor=color.new(color.gray, 20), text_color=color.white)
    table.cell(panel, 1, 5, str.tostring(win_rate, "#.#") + "%", bgcolor=color.new(color.gray, 80), text_color=color.white)
    
    table.cell(panel, 0, 6, "ê±°ëž˜íšŸìˆ˜", bgcolor=color.new(color.gray, 20), text_color=color.white)
    table.cell(panel, 1, 6, str.tostring(strategy.closedtrades), bgcolor=color.new(color.blue, 20), text_color=color.white)


