//@version=6
indicator("VMSI-SDM v4 Dynamic", overlay=true, max_boxes_count=500, max_labels_count=500, max_lines_count=500)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ“Œ v4 Dynamic - ì™„ì „ ë™ì  SL/TP + ì‹ í˜¸ ë²ˆí˜¸ + ë§¤ë„ ì‹ í˜¸
// 
// ë³€ê²½ì‚¬í•­:
// 1. ë™ì  SL/TP: ATR + VCP + ì‹ í˜¸ ê°•ë„ ê¸°ë°˜
// 2. ì‹ í˜¸ ë²ˆí˜¸: ê° ì‹ í˜¸ì— ê³ ìœ  ë²ˆí˜¸ ë¶€ì—¬
// 3. ë§¤ë„ ì‹ í˜¸ ê°•í™”: ì¡°ê±´ ì™„í™”ë¡œ ë§¤ë„ ì‹ í˜¸ ì¦ê°€
// 4. ë¼ë²¨ ìƒì„¸ ì •ë³´: í´ë¦­ ì‹œ ìƒì„¸ ë°ì´í„° í‘œì‹œ
// 5. í…Œì´ë¸” ì‹¤ì‹œê°„: í˜„ì¬ ë´‰ ìƒíƒœ í‘œì‹œ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PARAMETERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

var g_basic = "ê¸°ë³¸ ì„¤ì •"
ema1_len = input.int(20, "EMA1 ê¸°ê°„", group=g_basic)
ema2_len = input.int(50, "EMA2 ê¸°ê°„", group=g_basic)
rsi_len = input.int(14, "RSI ê¸°ê°„", group=g_basic)
vcp_len = input.int(20, "VCP ê¸°ê°„", group=g_basic)
atr_len = input.int(14, "ATR ê¸°ê°„", group=g_basic)

var g_signal = "ì‹ í˜¸ ì¡°ê±´"
trend_score_buy = input.float(55, "íŠ¸ë Œë“œ ìŠ¤ì½”ì–´ (ë§¤ìˆ˜)", minval=50, maxval=80, step=5, group=g_signal)
trend_score_sell = input.float(45, "íŠ¸ë Œë“œ ìŠ¤ì½”ì–´ (ë§¤ë„)", minval=20, maxval=50, step=5, group=g_signal)
rsi_buy_min = input.float(48, "RSI ìµœì†Œê°’ (ë§¤ìˆ˜)", minval=30, maxval=70, step=2, group=g_signal)
rsi_sell_max = input.float(52, "RSI ìµœëŒ€ê°’ (ë§¤ë„)", minval=30, maxval=70, step=2, group=g_signal)
vol_mult_min = input.float(1.2, "ê±°ë˜ëŸ‰ë°°ìˆ˜ ìµœì†Œê°’", minval=0.5, maxval=3, step=0.1, group=g_signal)

var g_weights = "ê°€ì¤‘ì¹˜"
alpha = input.float(0.8, "Alpha (EMA)", step=0.05, group=g_weights)
beta = input.float(0.35, "Beta (RSI)", step=0.05, group=g_weights)
gamma = input.float(0.7, "Gamma (Volume)", step=0.05, group=g_weights)
delta = input.float(0.6, "Delta (VCP)", step=0.05, group=g_weights)

var g_sltp = "ì†ìµ ì„¤ì • (ë™ì )"
use_atr_based = input.bool(true, "ATR ê¸°ë°˜ SL/TP ì‚¬ìš©", group=g_sltp)
atr_sl_mult = input.float(1.5, "ATR SL ë°°ìˆ˜", step=0.1, minval=0.5, maxval=5, group=g_sltp)
atr_tp_mult = input.float(2.5, "ATR TP ë°°ìˆ˜", step=0.1, minval=1, maxval=10, group=g_sltp)
fixed_sl_pct = input.float(5.0, "ê³ ì • ì†ì ˆ % (ATR ë¹„í™œì„±í™” ì‹œ)", step=0.5, minval=1, maxval=20, group=g_sltp)
fixed_tp_pct = input.float(10.0, "ê³ ì • ìµì ˆ % (ATR ë¹„í™œì„±í™” ì‹œ)", step=0.5, minval=2, maxval=50, group=g_sltp)
show_sltp_lines = input.bool(true, "SL/TP ë¼ì¸ í‘œì‹œ", group=g_sltp)
sltp_line_width = input.int(1, "ë¼ì¸ ë‘ê»˜", minval=1, maxval=3, group=g_sltp)

var g_display = "í‘œì‹œ ì˜µì…˜"
show_signals = input.bool(true, "ë§¤ìˆ˜/ë§¤ë„ ì‹ í˜¸ í‘œì‹œ", group=g_display)
show_signal_numbers = input.bool(true, "ì‹ í˜¸ ë²ˆí˜¸ í‘œì‹œ", group=g_display)
label_size_option = input.string("Small", "ë¼ë²¨ í¬ê¸°", options=["Tiny", "Small", "Normal"], group=g_display)

var g_webhook = "ì›¹í›…"
webhook_url = input.string("", "Webhook URL", group=g_webhook)
enable_webhook = input.bool(true, "ì›¹í›… í™œì„±í™”", group=g_webhook)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

clamp(x, lo, hi) => math.max(lo, math.min(hi, x))
safe_div(a, b, fallback) => nz(b > 0 ? a / b : fallback, fallback)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INDICATORS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ema1 = ta.ema(close, ema1_len)
ema2 = ta.ema(close, ema2_len)
rsi = ta.rsi(close, rsi_len)
vol_avg = ta.sma(volume, 20)
vol_mult = safe_div(volume, vol_avg, 1.0)
vcp_high = ta.highest(high, vcp_len)
vcp_low = ta.lowest(low, vcp_len)
vcp_ratio = safe_div(vcp_high - vcp_low, vcp_high, 0.5)
atr_val = ta.atr(atr_len)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TREND SCORE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

calc_trend_score() =>
    ema_above = ema1 > ema2 ? 1.0 : 0.0
    rsi_norm = rsi / 100.0
    vol_norm = math.min(vol_mult / 3.0, 1.0)
    vcp_norm = 1.0 - vcp_ratio
    raw = (alpha * ema_above + beta * rsi_norm + gamma * vol_norm + delta * vcp_norm) * 100.0
    clamp(raw, 0.0, 100.0)

trend_score = calc_trend_score()

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DYNAMIC SL/TP CALCULATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

calc_dynamic_sl_tp(signal_type) =>
    var float sl_distance = 0.0
    var float tp_distance = 0.0
    
    if use_atr_based
        // ATR ê¸°ë°˜ ê³„ì‚°
        base_sl = atr_val * atr_sl_mult
        base_tp = atr_val * atr_tp_mult
        
        // VCPë¡œ ì¡°ì • (ë³€ë™ì„± ë†’ìœ¼ë©´ SL/TP í™•ëŒ€)
        vcp_adjustment = 1.0 + (vcp_ratio * 0.5)
        sl_distance := base_sl * vcp_adjustment
        tp_distance := base_tp * vcp_adjustment
    else
        // ê³ ì • % ê¸°ë°˜
        sl_distance := close * (fixed_sl_pct / 100.0)
        tp_distance := close * (fixed_tp_pct / 100.0)
    
    // ì‹ í˜¸ ê°•ë„ì— ë”°ë¼ ë¯¸ì„¸ ì¡°ì •
    if trend_score >= 70 or trend_score <= 30
        // ê°•í•œ ì‹ í˜¸: TP í™•ëŒ€
        tp_distance := tp_distance * 1.2
    
    [sl_distance, tp_distance]

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SIGNAL LOGIC
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// ë§¤ìˆ˜ ì‹ í˜¸ (ì¡°ê±´ ì™„í™”)
buy_signal = barstate.isconfirmed and trend_score >= trend_score_buy and rsi > rsi_buy_min and vol_mult > vol_mult_min and ema1 > ema2

// ë§¤ë„ ì‹ í˜¸ (ì¡°ê±´ ì™„í™”)
sell_signal = barstate.isconfirmed and trend_score <= trend_score_sell and rsi < rsi_sell_max and vol_mult > vol_mult_min and ema1 < ema2

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SIGNAL TRACKING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

var int buy_counter = 0
var int sell_counter = 0

if buy_signal
    buy_counter := buy_counter + 1
    
if sell_signal
    sell_counter := sell_counter + 1

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VISUALIZATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

plot(ema1, "EMA1", color=color.new(color.blue, 0), linewidth=2)
plot(ema2, "EMA2", color=color.new(color.orange, 0), linewidth=2)

label_size = label_size_option == "Tiny" ? size.tiny : label_size_option == "Small" ? size.small : size.normal

// ë§¤ìˆ˜ ì‹ í˜¸ í‘œì‹œ
if show_signals and buy_signal
    [sl_dist, tp_dist] = calc_dynamic_sl_tp("BUY")
    
    entry_price = close
    sl_price = entry_price - sl_dist
    tp_price = entry_price + tp_dist
    
    sl_pct = (sl_dist / entry_price) * 100
    tp_pct = (tp_dist / entry_price) * 100
    
    // ë¼ë²¨ í…ìŠ¤íŠ¸ ìƒì„± (ìƒì„¸ ì •ë³´ í¬í•¨)
    label_text = show_signal_numbers ? str.tostring(buy_counter) : "ë§¤ìˆ˜"
    tooltip_text = "ë§¤ìˆ˜ #" + str.tostring(buy_counter) + "\n" +
                   "ê°€ê²©: " + str.tostring(entry_price, "#.##") + "\n" +
                   "SL: " + str.tostring(sl_price, "#.##") + " (-" + str.tostring(sl_pct, "#.#") + "%)\n" +
                   "TP: " + str.tostring(tp_price, "#.##") + " (+" + str.tostring(tp_pct, "#.#") + "%)\n" +
                   "RSI: " + str.tostring(rsi, "#.#") + " | Vol: " + str.tostring(vol_mult, "#.#") + "x\n" +
                   "Trend: " + str.tostring(trend_score, "#.#")
    
    label.new(bar_index, low, label_text, 
              style=label.style_label_up, 
              color=color.new(color.green, 0), 
              textcolor=color.white, 
              size=label_size,
              tooltip=tooltip_text)
    
    // SL/TP ë¼ì¸ ìƒì„±
    if show_sltp_lines
        // ì§„ì…ê°€ ë¼ì¸
        line.new(bar_index, entry_price, bar_index + 20, entry_price, 
                 color=color.new(color.blue, 50), width=sltp_line_width, style=line.style_solid)
        
        // ì†ì ˆê°€ ë¼ì¸
        line.new(bar_index, sl_price, bar_index + 20, sl_price, 
                 color=color.new(color.red, 0), width=sltp_line_width, style=line.style_dashed)
        
        // ìµì ˆê°€ ë¼ì¸
        line.new(bar_index, tp_price, bar_index + 20, tp_price, 
                 color=color.new(color.lime, 0), width=sltp_line_width, style=line.style_dashed)
        
        // ë²ˆí˜¸ ë¼ë²¨ (SL/TP)
        if show_signal_numbers
            label.new(bar_index + 5, sl_price, "#" + str.tostring(buy_counter) + " SL", 
                      style=label.style_label_left, color=color.new(color.red, 30), 
                      textcolor=color.white, size=size.tiny)
            label.new(bar_index + 5, tp_price, "#" + str.tostring(buy_counter) + " TP", 
                      style=label.style_label_left, color=color.new(color.lime, 30), 
                      textcolor=color.black, size=size.tiny)

// ë§¤ë„ ì‹ í˜¸ í‘œì‹œ
if show_signals and sell_signal
    [sl_dist, tp_dist] = calc_dynamic_sl_tp("SELL")
    
    entry_price = close
    sl_price = entry_price + sl_dist
    tp_price = entry_price - tp_dist
    
    sl_pct = (sl_dist / entry_price) * 100
    tp_pct = (tp_dist / entry_price) * 100
    
    // ë¼ë²¨ í…ìŠ¤íŠ¸ ìƒì„±
    label_text = show_signal_numbers ? str.tostring(sell_counter) : "ë§¤ë„"
    tooltip_text = "ë§¤ë„ #" + str.tostring(sell_counter) + "\n" +
                   "ê°€ê²©: " + str.tostring(entry_price, "#.##") + "\n" +
                   "SL: " + str.tostring(sl_price, "#.##") + " (+" + str.tostring(sl_pct, "#.#") + "%)\n" +
                   "TP: " + str.tostring(tp_price, "#.##") + " (-" + str.tostring(tp_pct, "#.#") + "%)\n" +
                   "RSI: " + str.tostring(rsi, "#.#") + " | Vol: " + str.tostring(vol_mult, "#.#") + "x\n" +
                   "Trend: " + str.tostring(trend_score, "#.#")
    
    label.new(bar_index, high, label_text, 
              style=label.style_label_down, 
              color=color.new(color.red, 0), 
              textcolor=color.white, 
              size=label_size,
              tooltip=tooltip_text)
    
    // ë§¤ë„ëŠ” ì¸ë²„ìŠ¤ìš©ì´ë¯€ë¡œ SL/TP ë¼ì¸ í‘œì‹œ ì•ˆ í•¨ (ìš”ì²­ì‚¬í•­)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INFO PANEL (ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

var table panel = table.new(position.top_right, 2, 7, border_width=1)
if true  // í•­ìƒ ì—…ë°ì´íŠ¸ (barstate.islast ì œê±°)
    table.cell(panel, 0, 0, "í˜„ì¬ ê°€ê²©", bgcolor=color.new(color.gray, 20), text_color=color.white)
    table.cell(panel, 1, 0, str.tostring(close, "#.##"), bgcolor=color.new(color.gray, 80), text_color=color.white)
    
    table.cell(panel, 0, 1, "Trend Score", bgcolor=color.new(color.gray, 20), text_color=color.white)
    ts_color = trend_score >= 60 ? color.new(color.green, 20) : (trend_score <= 40 ? color.new(color.red, 20) : color.new(color.gray, 80))
    table.cell(panel, 1, 1, str.tostring(trend_score, "#.0"), bgcolor=ts_color, text_color=color.white)
    
    table.cell(panel, 0, 2, "RSI", bgcolor=color.new(color.gray, 20), text_color=color.white)
    rsi_color = rsi > 60 ? color.new(color.green, 20) : (rsi < 40 ? color.new(color.red, 20) : color.new(color.gray, 80))
    table.cell(panel, 1, 2, str.tostring(rsi, "#.0"), bgcolor=rsi_color, text_color=color.white)
    
    table.cell(panel, 0, 3, "ê±°ë˜ëŸ‰ë°°ìˆ˜", bgcolor=color.new(color.gray, 20), text_color=color.white)
    vol_color = vol_mult > 2 ? color.new(color.orange, 20) : color.new(color.gray, 80)
    table.cell(panel, 1, 3, str.tostring(vol_mult, "#.#") + "x", bgcolor=vol_color, text_color=color.white)
    
    table.cell(panel, 0, 4, "EMA ì •ë ¬", bgcolor=color.new(color.gray, 20), text_color=color.white)
    ema_status = ema1 > ema2 ? "ì •ë°°ì—´" : "ì—­ë°°ì—´"
    ema_color = ema1 > ema2 ? color.new(color.green, 20) : color.new(color.red, 20)
    table.cell(panel, 1, 4, ema_status, bgcolor=ema_color, text_color=color.white)
    
    table.cell(panel, 0, 5, "ATR", bgcolor=color.new(color.gray, 20), text_color=color.white)
    table.cell(panel, 1, 5, str.tostring(atr_val, "#.##"), bgcolor=color.new(color.gray, 80), text_color=color.white)
    
    table.cell(panel, 0, 6, "ì‹ í˜¸ ìˆ˜", bgcolor=color.new(color.gray, 20), text_color=color.white)
    signal_text = "ë§¤ìˆ˜:" + str.tostring(buy_counter) + " ë§¤ë„:" + str.tostring(sell_counter)
    table.cell(panel, 1, 6, signal_text, bgcolor=color.new(color.blue, 20), text_color=color.white)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WEBHOOK ALERT (ë™ì  SL/TP í¬í•¨)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

if enable_webhook and buy_signal
    [sl_dist, tp_dist] = calc_dynamic_sl_tp("BUY")
    sl_price = close - sl_dist
    tp_price = close + tp_dist
    
    json_p1 = '{"ts_unix":' + str.tostring(time, "#") + ',"symbol":"' + syminfo.ticker + '","timeframe":"' + timeframe.period + '"'
    json_p2 = ',"action":"BUY","price":' + str.tostring(close, "#.##") + ',"signal_number":' + str.tostring(buy_counter)
    json_p3 = ',"trend_score":' + str.tostring(trend_score, "#.##")
    json_p4 = ',"rsi":' + str.tostring(rsi, "#.##") + ',"vol_mult":' + str.tostring(vol_mult, "#.##")
    json_p5 = ',"ema1":' + str.tostring(ema1, "#.##") + ',"ema2":' + str.tostring(ema2, "#.##")
    json_p6 = ',"sl_price":' + str.tostring(sl_price, "#.##") + ',"tp_price":' + str.tostring(tp_price, "#.##")
    json_p7 = ',"atr":' + str.tostring(atr_val, "#.##") + ',"vcp_ratio":' + str.tostring(vcp_ratio, "#.####")
    json_p8 = ',"version":"vmsi_sdm_v4_dynamic"}'
    alert_msg = json_p1 + json_p2 + json_p3 + json_p4 + json_p5 + json_p6 + json_p7 + json_p8
    alert(alert_msg, alert.freq_once_per_bar_close)

if enable_webhook and sell_signal
    [sl_dist, tp_dist] = calc_dynamic_sl_tp("SELL")
    sl_price = close + sl_dist
    tp_price = close - tp_dist
    
    json_p1 = '{"ts_unix":' + str.tostring(time, "#") + ',"symbol":"' + syminfo.ticker + ',"timeframe":"' + timeframe.period + '"'
    json_p2 = ',"action":"SELL","price":' + str.tostring(close, "#.##") + ',"signal_number":' + str.tostring(sell_counter)
    json_p3 = ',"trend_score":' + str.tostring(trend_score, "#.##")
    json_p4 = ',"rsi":' + str.tostring(rsi, "#.##") + ',"vol_mult":' + str.tostring(vol_mult, "#.##")
    json_p5 = ',"ema1":' + str.tostring(ema1, "#.##") + ',"ema2":' + str.tostring(ema2, "#.##")
    json_p6 = ',"sl_price":' + str.tostring(sl_price, "#.##") + ',"tp_price":' + str.tostring(tp_price, "#.##")
    json_p7 = ',"atr":' + str.tostring(atr_val, "#.##") + ',"vcp_ratio":' + str.tostring(vcp_ratio, "#.####")
    json_p8 = ',"version":"vmsi_sdm_v4_dynamic"}'
    alert_msg = json_p1 + json_p2 + json_p3 + json_p4 + json_p5 + json_p6 + json_p7 + json_p8
    alert(alert_msg, alert.freq_once_per_bar_close)

