//@version=6
strategy("VMSI-SDM Strategy v2.1", overlay=true, initial_capital=100000, default_qty_type=strategy.percent_of_equity, default_qty_value=100, commission_type=strategy.commission.percent, commission_value=0.1)

var g_preset = "프리셋"
preset_type = input.string("Custom", "프리셋", options=["Custom", "Equity Swing", "Crypto Intraday", "Forex Scalping", "Index Position"], group=g_preset)

get_preset_values() =>
    if preset_type == "Equity Swing"
        [20, 50, 14, 20, 0.8, 7, 10]
    else if preset_type == "Crypto Intraday"
        [12, 26, 10, 14, 0.5, 3, 5]
    else if preset_type == "Forex Scalping"
        [9, 21, 7, 10, 0.3, 1, 2]
    else if preset_type == "Index Position"
        [30, 100, 21, 30, 1.0, 10, 15]
    else
        [20, 50, 14, 20, 0.8, 5, 10]

[preset_ema1, preset_ema2, preset_rsi, preset_vcp, preset_eps, preset_hyst, preset_cool] = get_preset_values()

var g_params = "파라미터"
ema1_len = input.int(20, "EMA1", group=g_params)
ema2_len = input.int(50, "EMA2", group=g_params)
rsi_len = input.int(14, "RSI", group=g_params)
vcp_len = input.int(20, "VCP", group=g_params)
rsi_buy_th = input.float(55, "RSI 매수선", group=g_params)
rsi_sell_th = input.float(45, "RSI 매도선", group=g_params)
vol_mult_buy = input.float(1.5, "거래량배수 매수", group=g_params)
vol_mult_sell = input.float(1.3, "거래량배수 매도", group=g_params)

alpha = input.float(0.8, "Alpha", step=0.05, group=g_params)
beta = input.float(0.35, "Beta", step=0.05, group=g_params)
gamma = input.float(0.7, "Gamma", step=0.05, group=g_params)
delta = input.float(0.6, "Delta", step=0.05, group=g_params)
epsilon = input.float(0.8, "Epsilon", step=0.05, group=g_params)
hysteresis_len = input.int(5, "히스테리시스", group=g_params)
cooldown_bars = input.int(10, "쿨다운", group=g_params)

vix_w = input.float(-0.3, "VIX 가중치", step=0.1, group=g_params)
dxy_w = input.float(-0.2, "DXY 가중치", step=0.1, group=g_params)
us10y_w = input.float(-0.2, "US10Y 가중치", step=0.1, group=g_params)
hygief_w = input.float(0.4, "HYG/IEF 가중치", step=0.1, group=g_params)

ema1_len_final = preset_type == "Custom" ? ema1_len : preset_ema1
ema2_len_final = preset_type == "Custom" ? ema2_len : preset_ema2
rsi_len_final = preset_type == "Custom" ? rsi_len : preset_rsi
vcp_len_final = preset_type == "Custom" ? vcp_len : preset_vcp
epsilon_final = preset_type == "Custom" ? epsilon : preset_eps
hysteresis_len_final = preset_type == "Custom" ? hysteresis_len : preset_hyst
cooldown_bars_final = preset_type == "Custom" ? cooldown_bars : preset_cool

var g_mode = "모드"
fast_mode = input.bool(false, "Fast Mode", group=g_mode)
use_realtime_macro = input.bool(false, "실시간 매크로", group=g_mode)

var g_macro = "매크로 심볼"
vix_symbol = input.symbol("CBOE:VIX", "VIX", group=g_macro)
dxy_symbol = input.symbol("TVC:DXY", "DXY", group=g_macro)
us10y_symbol = input.symbol("TVC:US10Y", "US10Y", group=g_macro)
hyg_symbol = input.symbol("AMEX:HYG", "HYG", group=g_macro)
ief_symbol = input.symbol("NASDAQ:IEF", "IEF", group=g_macro)

var g_table = "패널"
table_position = input.string("Top Right", "위치", options=["Top Right", "Top Left", "Bottom Right", "Bottom Left"], group=g_table)
table_size = input.string("Normal", "크기", options=["Large", "Normal", "Small"], group=g_table)

var g_risk = "리스크"
use_sl_tp = input.bool(true, "SL/TP 사용", group=g_risk)
use_atr_based = input.bool(false, "ATR 기반", group=g_risk)
sl_pct = input.float(5.0, "손절 %", step=0.5, group=g_risk)
tp_pct = input.float(10.0, "익절 %", step=0.5, group=g_risk)
atr_len = input.int(14, "ATR 기간", group=g_risk)
atr_sl_mult = input.float(2.0, "ATR SL 배수", step=0.1, group=g_risk)
atr_tp_mult = input.float(3.0, "ATR TP 배수", step=0.1, group=g_risk)

var g_sizing = "포지션"
use_risk_based_sizing = input.bool(false, "리스크 기반 사이징", group=g_sizing)
risk_per_trade = input.float(2.0, "거래당 리스크 %", step=0.5, group=g_sizing)

clamp(x, lo, hi) => math.max(lo, math.min(hi, x))
safe_div(a, b, fallback) => nz(b > 0 ? a / b : fallback, fallback)

ema1 = ta.ema(close, ema1_len_final)
ema2 = ta.ema(close, ema2_len_final)
rsi = ta.rsi(close, rsi_len_final)
vol_avg = ta.sma(volume, 20)
vol_mult = safe_div(volume, vol_avg, 1.0)
vcp_high = ta.highest(high, vcp_len_final)
vcp_low = ta.lowest(low, vcp_len_final)
vcp_ratio = safe_div(vcp_high - vcp_low, vcp_high, 0.5)
atr_val = ta.atr(atr_len)
ath = ta.highest(high, 252)
dist_ath = safe_div(ath - close, ath, 0.0)

calc_proxy_macro_signal() =>
    atr_baseline = ta.sma(atr_val, 100)
    volatility_ratio = safe_div(atr_val, atr_baseline, 1.0)
    if volatility_ratio > 1.2
        -1.0
    else if volatility_ratio < 0.8
        +1.0
    else
        0.0

fetch_macro_live() =>
    vix = request.security(vix_symbol, timeframe.period, close)
    dxy = request.security(dxy_symbol, timeframe.period, close)
    us10y = request.security(us10y_symbol, timeframe.period, close)
    hyg = request.security(hyg_symbol, timeframe.period, close)
    ief = request.security(ief_symbol, timeframe.period, close)
    vix_val = nz(vix, 18.4)
    dxy_val = nz(dxy, 104.5)
    us10y_val = nz(us10y, 4.5)
    hyg_close = nz(hyg, 79.0)
    ief_close = nz(ief, 95.0)
    hygief_ratio = safe_div(hyg_close, ief_close, 0.83)
    dxy_trend = ta.ema(dxy_val, 10) > ta.ema(dxy_val, 30) ? 1.0 : -1.0
    us10y_trend = ta.ema(us10y_val, 10) > ta.ema(us10y_val, 30) ? 1.0 : -1.0
    hygief_sig = hygief_ratio > ta.ema(hygief_ratio, 20) ? 1.0 : -1.0
    vix_w * (vix_val / 20.0) + dxy_w * dxy_trend + us10y_w * us10y_trend + hygief_w * hygief_sig

macro_score = use_realtime_macro ? fetch_macro_live() : epsilon_final * calc_proxy_macro_signal()

calc_trend_score() =>
    ema_above = ema1 > ema2 ? 1.0 : 0.0
    rsi_norm = rsi / 100.0
    vol_norm = math.min(vol_mult / 3.0, 1.0)
    vcp_norm = 1.0 - vcp_ratio
    raw = (alpha * ema_above + beta * rsi_norm + gamma * vol_norm + delta * vcp_norm) * 100.0
    clamp(raw, 0.0, 100.0)

calc_prob(ts, macro_sig) =>
    raw = (ts / 100.0 + epsilon_final * macro_sig) / (1.0 + epsilon_final)
    clamp(raw, 0.0, 1.0)

trend_score = calc_trend_score()
prob = calc_prob(trend_score, macro_score)
trend_score_smooth = fast_mode ? trend_score : ta.sma(trend_score, hysteresis_len_final)
prob_smooth = fast_mode ? prob : ta.sma(prob, hysteresis_len_final)

var string stage = "중립"
var int last_signal_bar = 0
var string last_signal = ""

bars_since_signal = bar_index - last_signal_bar
cooldown_passed = fast_mode ? true : (bars_since_signal >= cooldown_bars_final)

if barstate.isconfirmed
    if cooldown_passed
        if trend_score_smooth >= 70 and prob_smooth >= 0.60 and rsi > rsi_buy_th and vol_mult > vol_mult_buy
            stage := "강한 매수"
            last_signal := "BUY"
            last_signal_bar := bar_index
        else if trend_score_smooth <= 30 and prob_smooth <= 0.40 and rsi < rsi_sell_th and vol_mult > vol_mult_sell
            stage := "강한 매도"
            last_signal := "SELL"
            last_signal_bar := bar_index
        else if trend_score_smooth > 55 and prob_smooth > 0.55
            stage := "상승 관찰"
        else if trend_score_smooth < 45 and prob_smooth < 0.45
            stage := "하락 관찰"
        else
            stage := "중립"

calc_sl_dist() =>
    if use_atr_based
        atr_val * atr_sl_mult
    else
        close * (sl_pct / 100.0)

calc_tp_dist() =>
    if use_atr_based
        atr_val * atr_tp_mult
    else
        close * (tp_pct / 100.0)

calc_qty_for_risk() =>
    if use_risk_based_sizing
        account_value = strategy.equity
        risk_amount = account_value * (risk_per_trade / 100.0)
        sl_distance = calc_sl_dist()
        qty_based_on_risk = safe_div(risk_amount, sl_distance * close, 0.0)
        qty_max = account_value / close
        math.min(qty_based_on_risk, qty_max)
    else
        strategy.equity / close

if last_signal == "BUY" and bar_index == last_signal_bar and strategy.position_size == 0
    qty = calc_qty_for_risk()
    strategy.entry("Long", strategy.long, qty=qty)
    if use_sl_tp
        sl_price = close - calc_sl_dist()
        tp_price = close + calc_tp_dist()
        strategy.exit("Long Exit", "Long", stop=sl_price, limit=tp_price)

if last_signal == "SELL" and bar_index == last_signal_bar and strategy.position_size == 0
    qty = calc_qty_for_risk()
    strategy.entry("Short", strategy.short, qty=qty)
    if use_sl_tp
        sl_price = close + calc_sl_dist()
        tp_price = close - calc_tp_dist()
        strategy.exit("Short Exit", "Short", stop=sl_price, limit=tp_price)

if strategy.position_size > 0 and last_signal == "SELL" and bar_index == last_signal_bar
    strategy.close("Long", comment="Reverse")

if strategy.position_size < 0 and last_signal == "BUY" and bar_index == last_signal_bar
    strategy.close("Short", comment="Reverse")

var label fast_badge = na
if fast_mode and bar_index % 50 == 0
    label.delete(fast_badge)
    fast_badge := label.new(bar_index, high * 1.02, "⚡ FAST MODE", color=color.new(color.yellow, 0), textcolor=color.black, style=label.style_label_down, size=size.small)

bgcolor_col = stage == "강한 매수" ? color.new(color.green, 70) : stage == "강한 매도" ? color.new(color.red, 70) : stage == "상승 관찰" ? color.new(color.blue, 85) : stage == "하락 관찰" ? color.new(color.orange, 85) : color.new(color.gray, 95)
bgcolor(bgcolor_col)

plot(ema1, "EMA20 (단기)", color=color.blue, linewidth=2)
plot(ema2, "EMA50 (장기)", color=color.orange, linewidth=2)

panel_pos = table_position == "Top Right" ? position.top_right : table_position == "Top Left" ? position.top_left : table_position == "Bottom Right" ? position.bottom_right : position.bottom_left
text_size_label = table_size == "Large" ? size.large : table_size == "Small" ? size.small : size.normal
text_size_value = table_size == "Large" ? size.normal : table_size == "Small" ? size.tiny : size.small
text_size_stage = table_size == "Large" ? size.huge : table_size == "Small" ? size.normal : size.large

var table panel = table.new(panel_pos, 2, 10, border_width=2)
if true
    mode_text = fast_mode ? "FAST" : "NORMAL"
    mode_color = fast_mode ? color.new(color.yellow, 0) : color.new(color.blue, 0)
    table.cell(panel, 0, 0, "Mode", bgcolor=color.new(color.gray, 20), text_color=color.white, text_size=text_size_label)
    table.cell(panel, 1, 0, mode_text, bgcolor=mode_color, text_color=color.white, text_size=text_size_value)
    
    stage_bg = stage == "강한 매수" ? color.new(color.green, 20) : stage == "강한 매도" ? color.new(color.red, 20) : stage == "상승 관찰" ? color.new(color.blue, 20) : stage == "하락 관찰" ? color.new(color.orange, 20) : color.new(color.gray, 20)
    table.cell(panel, 0, 1, "시장상태", bgcolor=color.new(color.gray, 20), text_color=color.white, text_size=text_size_label)
    table.cell(panel, 1, 1, stage, bgcolor=stage_bg, text_color=color.white, text_size=text_size_stage)
    
    table.cell(panel, 0, 2, "TScore", bgcolor=color.new(color.gray, 20), text_color=color.white, text_size=text_size_label)
    table.cell(panel, 1, 2, str.tostring(trend_score_smooth, "#.0"), bgcolor=color.new(color.gray, 80), text_color=color.white, text_size=text_size_value)
    
    table.cell(panel, 0, 3, "Prob", bgcolor=color.new(color.gray, 20), text_color=color.white, text_size=text_size_label)
    table.cell(panel, 1, 3, str.tostring(prob_smooth, "#.##"), bgcolor=color.new(color.gray, 80), text_color=color.white, text_size=text_size_value)
    
    pos_text = strategy.position_size > 0 ? "롱" : strategy.position_size < 0 ? "숏" : "대기"
    pos_color = strategy.position_size > 0 ? color.new(color.green, 20) : strategy.position_size < 0 ? color.new(color.red, 20) : color.new(color.gray, 20)
    table.cell(panel, 0, 4, "포지션", bgcolor=color.new(color.gray, 20), text_color=color.white, text_size=text_size_label)
    table.cell(panel, 1, 4, pos_text, bgcolor=pos_color, text_color=color.white, text_size=text_size_value)
    
    pnl_pct = strategy.position_size != 0 ? (close - strategy.position_avg_price) / strategy.position_avg_price * 100 : 0
    pnl_color = pnl_pct > 0 ? color.new(color.green, 20) : pnl_pct < 0 ? color.new(color.red, 20) : color.new(color.gray, 80)
    table.cell(panel, 0, 5, "현재손익", bgcolor=color.new(color.gray, 20), text_color=color.white, text_size=text_size_label)
    table.cell(panel, 1, 5, str.tostring(pnl_pct, "#.##") + "%", bgcolor=pnl_color, text_color=color.white, text_size=text_size_value)
    
    sltp_text = use_sl_tp ? use_atr_based ? "ATR" : "고정" : "OFF"
    sltp_color = use_sl_tp ? use_atr_based ? color.new(color.purple, 20) : color.new(color.blue, 20) : color.new(color.gray, 80)
    table.cell(panel, 0, 6, "SL/TP", bgcolor=color.new(color.gray, 20), text_color=color.white, text_size=text_size_label)
    table.cell(panel, 1, 6, sltp_text, bgcolor=sltp_color, text_color=color.white, text_size=text_size_value)
    
    table.cell(panel, 0, 7, "ATR", bgcolor=color.new(color.gray, 20), text_color=color.white, text_size=text_size_label)
    table.cell(panel, 1, 7, str.tostring(atr_val, "#.##"), bgcolor=color.new(color.gray, 80), text_color=color.white, text_size=text_size_value)
    
    total_profit = strategy.netprofit / strategy.initial_capital * 100
    total_color = total_profit > 0 ? color.new(color.green, 20) : total_profit < 0 ? color.new(color.red, 20) : color.new(color.gray, 80)
    table.cell(panel, 0, 8, "총수익", bgcolor=color.new(color.gray, 20), text_color=color.white, text_size=text_size_label)
    table.cell(panel, 1, 8, str.tostring(total_profit, "#.##") + "%", bgcolor=total_color, text_color=color.white, text_size=text_size_value)
    
    win_rate = strategy.wintrades > 0 ? strategy.wintrades / (strategy.wintrades + strategy.losstrades) * 100 : 0
    table.cell(panel, 0, 9, "승률", bgcolor=color.new(color.gray, 20), text_color=color.white, text_size=text_size_label)
    table.cell(panel, 1, 9, str.tostring(win_rate, "#.#") + "%", bgcolor=color.new(color.gray, 80), text_color=color.white, text_size=text_size_value)
